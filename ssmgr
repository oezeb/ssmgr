#!/bin/bash

USER_FILE="/etc/ss-users/ss_users.txt"
CONFIG_DIR="/etc/ss-users/configs"
PID_DIR="/var/run/ss-users"

mkdir -p "$CONFIG_DIR" "$PID_DIR"
touch "$USER_FILE"

gen_password() {
    head -c 12 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9' | head -c 16
}

gen_config() {
    local port=$1
    local password=$2
    local config="$CONFIG_DIR/$port.json"

    cat > "$config" <<EOF
{
    "server": "0.0.0.0",
    "server_port": $port,
    "password": "$password",
    "timeout": 300,
    "method":"chacha20-ietf-poly1305",
    "plugin":"obfs-server",
    "plugin_opts":"obfs=tls"
}
EOF
}

add_user() {
    local port=$1
    local user=$2
    local password=$3

    if [[ -z "$port" || -z "$user" ]]; then
        echo "Usage: $0 add <port> <username> [password]"
        return 1
    fi

    if grep -q "^$port," "$USER_FILE"; then
        echo "Port $port already assigned. Remove it first."
        return
    fi

    [[ -z "$password" ]] && password=$(gen_password)

    gen_config "$port" "$password"
    echo "$port,$user,$password" >> "$USER_FILE"
    echo "Added user $user with password $password on port $port"
    
    echo "Starting ss-user@$port service"
    systemctl daemon-reexec
    systemctl daemon-reload
    ssctl start "$port"
    sslimit add "$port"
}

remove_user() {
    local port=$1
    
    if [[ -z "$port" ]]; then
        echo "Usage: $0 remove <port>"
        return 1
    fi

    ssctl stop "$port"
    sslimit remove "$port"
    sed -i "/^$port,/d" "$USER_FILE"
    rm -f "$CONFIG_DIR/$port.json"
}

list_users() {
    echo -e "PORT\tUSER\t\tPASSWORD"
    echo "------------------------------------------------------------"
    while IFS=',' read -r port user password; do
        printf "%-6s\t%-10s\t%-16s\n" "$port" "$user" "$password"
    done < "$USER_FILE"
}

usage() {
    echo "Usage:"
    echo "  $0 add <port> <username> [password]    # Add user (gen password if missing)"
    echo "  $0 remove <port>                       # Remove user"
    echo "  $0 list                                # Show users"
    exit 1
}

case "$1" in
    add) add_user "$2" "$3" "$4" ;;
    remove) remove_user "$2" ;;
    list) list_users ;;
    *) usage ;;
esac
